# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- master

pool:
  vmImage: ubuntu-latest

variables:
  AZURE_ENV_NAME: dev
  AZURE_LOCATION: eastus

steps:
- task: UseDotNet@2
  inputs:
    version: '9.x'
    displayName: Set up .NET 9

- task: UsePythonVersion@0
  inputs:
    versionSpec: '3.x'

- task: AzureCLI@2
  inputs:
    azureSubscription: 'acrserviceconnectionmanual'
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      # Install Azure Dev CLI (azd)
      curl -fsSL https://aka.ms/install-azd.sh | bash
      
      # Log in to Azure using the service connection (already handled)
      azd version
      azd config set auth.useAzCliAuth "true"
    
      # Set environment
      azd env set AZURE_LOCATION $AZURE_LOCATION
      azd env set AZURE_ENV_NAME $AZURE_ENV_NAME

      pwd
      ls -la
      
      # Initialize the project (skipped if already initialized)
      azd init --environment $AZURE_ENV_NAME --location $AZURE_LOCATION --no-prompt

      # Provision infrastructure with Terraform
      azd provision
